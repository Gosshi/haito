---
description: 要件、設計、タスクに対して実装を検証する
allowed-tools: Bash, Glob, Grep, Read, LS
argument-hint: [feature-name] [task-numbers]
---

# 実装検証

<background_information>
- **ミッション**: 実装が承認された要件、設計、タスクに整合していることを検証する
- **成功基準**:
  - 指定されたすべてのタスクが完了としてマークされている
  - 実装された機能のテストが存在しパスしている
  - 要件トレーサビリティが確認されている（EARS要件がカバーされている）
  - 設計構造が実装に反映されている
  - 既存機能にリグレッションがない
</background_information>

<instructions>
## コアタスク
承認された仕様に基づいて機能とタスクの実装を検証する。

## 実行ステップ

### 1. 検証対象の検出

**引数が提供されていない場合**（`$1`が空）:
- 会話履歴から`/kiro:spec-impl <feature> [tasks]`コマンドを解析
- 各実行から機能名とタスク番号を抽出
- 実装されたすべてのタスクを機能ごとに集約
- 検出された実装を報告（例: 「user-auth: 1.1, 1.2, 1.3」）
- 履歴が見つからない場合、完了タスク`[x]`を持つ機能のために`.kiro/specs/`をスキャン

**機能が提供された場合**（`$1`あり、`$2`なし）:
- 指定された機能を使用
- `.kiro/specs/$1/tasks.md`のすべての完了タスク`[x]`を検出

**機能とタスクの両方が提供された場合**（`$1`と`$2`あり）:
- 指定された機能とタスクのみを検証（例: `user-auth 1.1,1.2`）

### 2. コンテキストのロード

検出された各機能について:
- メタデータのために`.kiro/specs/<feature>/spec.json`を読む
- 要件のために`.kiro/specs/<feature>/requirements.md`を読む
- 設計構造のために`.kiro/specs/<feature>/design.md`を読む
- タスクリストのために`.kiro/specs/<feature>/tasks.md`を読む
- **すべてのステアリングコンテキストをロード**: 以下を含む`.kiro/steering/`ディレクトリ全体を読む:
  - デフォルトファイル: `structure.md`、`tech.md`、`product.md`
  - すべてのカスタムステアリングファイル（モード設定に関係なく）

### 3. 検証を実行

各タスクについて確認:

#### タスク完了チェック
- tasks.mdでチェックボックスが`[x]`である
- 完了していない場合、「タスクが完了としてマークされていない」としてフラグ

#### テストカバレッジチェック
- タスク関連機能のテストが存在する
- テストがパスする（失敗やエラーがない）
- Bashを使用してテストコマンドを実行（例: `npm test`、`pytest`）
- テストが失敗または存在しない場合、「テストカバレッジの問題」としてフラグ

#### 要件トレーサビリティ
- タスクに関連するEARS要件を特定
- Grepを使用して要件カバレッジの証拠を実装内で検索
- 要件がコードに追跡可能でない場合、「要件が実装されていない」としてフラグ

#### 設計整合性
- design.mdの構造が実装に反映されているか確認
- 主要なインターフェース、コンポーネント、モジュールが存在することを確認
- Grep/LSを使用してファイル構造が設計と一致することを確認
- 不整合が見つかった場合、「設計からの逸脱」としてフラグ

#### リグレッションチェック
- フルテストスイートを実行（利用可能な場合）
- 既存のテストが壊れていないことを確認
- リグレッションが検出された場合、「リグレッション検出」としてフラグ

### 4. レポートを生成

spec.jsonで指定された言語でサマリーを提供:
- 機能ごとの検証サマリー
- カバレッジレポート（タスク、要件、設計）
- 問題と逸脱（重大度: Critical/Warning）
- GO/NO-GO決定

## 重要な制約
- **会話認識**: 自動検出のために会話履歴を優先
- **非ブロッキング警告**: クリティカルでない限り、設計からの逸脱は警告
- **テスト優先フォーカス**: GO決定にはテストカバレッジが必須
- **トレーサビリティ必須**: すべての要件が実装に追跡可能でなければならない
</instructions>

## ツールガイダンス
- **会話解析**: 履歴から`/kiro:spec-impl`パターンを抽出
- **コンテキストを読む**: 検証前にすべてのspecとsteeringをロード
- **テスト用Bash**: テストコマンドを実行してパスステータスを確認
- **トレーサビリティ用Grep**: 要件の証拠をコードベースで検索
- **構造用LS/Glob**: ファイル構造が設計と一致することを確認

## 出力説明

spec.jsonで指定された言語で出力を提供:

1. **検出された対象**: 検証される機能とタスク（自動検出の場合）
2. **検証サマリー**: 機能ごとの簡潔な概要（パス/失敗カウント）
3. **問題**: 重大度と場所を含む検証失敗のリスト
4. **カバレッジレポート**: 要件/設計/タスクカバレッジのパーセンテージ
5. **決定**: GO（次フェーズの準備完了）/ NO-GO（修正が必要）

**フォーマット要件**:
- 明確にするためにMarkdown見出しとテーブルを使用
- 重大な問題に⚠️または🔴でフラグ
- サマリーを簡潔に保つ（400語以下）

## セーフティ＆フォールバック

### エラーシナリオ
- **実装が見つからない**: 履歴に`/kiro:spec-impl`がなく、`[x]`タスクもない場合、「実装が検出されませんでした」を報告
- **テストコマンドが不明**: テストフレームワークが不明な場合、警告しテスト検証をスキップ（手動確認が必要）
- **Specファイルがない**: spec.json/requirements.md/design.mdがない場合、エラーで停止
- **言語が未定義**: spec.jsonで言語が指定されていない場合、英語（`en`）にデフォルト

### 次ステップガイダンス

**GO決定の場合**:
- 実装が検証され準備完了
- デプロイメントまたは次の機能に進む

**NO-GO決定の場合**:
- リストされた重大な問題に対処
- 修正のために`/kiro:spec-impl <feature> [tasks]`を再実行
- `/kiro:validate-impl [feature] [tasks]`で再検証

**注記**: 検証は、spec整合性と品質を確保するために実装後に推奨される。
