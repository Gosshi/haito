---
description: 仕様の実装タスクを生成する
allowed-tools: Read, Write, Edit, MultiEdit, Glob, Grep
argument-hint: <feature-name> [-y] [--sequential]
---

# 実装タスクジェネレーター

<background_information>
- **ミッション**: 技術設計を実行可能な作業項目に変換する詳細で実行可能な実装タスクを生成する
- **成功基準**:
  - すべての要件が特定のタスクにマッピングされている
  - タスクが適切にサイズ設定されている（各1〜3時間）
  - 適切な階層を持つ明確なタスク進行
  - 機能に焦点を当てた自然言語の説明
</background_information>

<instructions>
## コアタスク
承認された要件と設計に基づいて機能 **$1** の実装タスクを生成する。

## 実行ステップ

### ステップ1: コンテキストのロード

**必要なコンテキストをすべて読み込む**:
- `.kiro/specs/$1/spec.json`、`requirements.md`、`design.md`
- `.kiro/specs/$1/tasks.md`（存在する場合、マージモード用）
- **完全なプロジェクトメモリのための`.kiro/steering/`ディレクトリ全体**

**承認の検証**:
- `-y`フラグが提供された場合（$2 == "-y"）: spec.jsonで要件と設計を自動承認
- それ以外: 両方が承認されていることを確認（されていない場合は停止、セーフティ＆フォールバックを参照）
- `--sequential`の有無に基づいてシーケンシャルモードを決定

### ステップ2: 実装タスクの生成

**生成ルールとテンプレートをロード**:
- 原則のために`.kiro/settings/rules/tasks-generation.md`を読む
- `sequential`が**false**の場合: 並列判断基準のために`.kiro/settings/rules/tasks-parallel-analysis.md`を読む
- フォーマットのために`.kiro/settings/templates/specs/tasks.md`を読む（`(P)`マーカーをサポート）

**すべてのルールに従ってタスクリストを生成**:
- spec.jsonで指定された言語を使用
- すべての要件をタスクにマッピング
- 要件カバレッジを文書化する際、数値要件IDのみをリスト（カンマ区切り）、説明的なサフィックス、括弧、翻訳、自由形式のラベルなし
- すべての設計コンポーネントが含まれていることを確認
- タスク進行が論理的で段階的であることを確認
- 単一サブタスク構造をメジャータスクに昇格させて折りたたみ、コンテナのみのメジャータスクでは詳細を重複させない（テンプレートパターンを適切に使用）
- 並列基準を満たすタスクに`(P)`マーカーを適用（シーケンシャルモードではマーカーを省略）
- コア実装で既に満たされている受け入れ基準を厳密にカバーし、MVP後に延期可能な場合のみ、オプションのテストカバレッジサブタスクを`- [ ]*`でマーク
- 既存のtasks.mdが見つかった場合、新しいコンテンツとマージ

### ステップ3: 確定

**書き込みと更新**:
- `.kiro/specs/$1/tasks.md`を作成/更新
- spec.jsonメタデータを更新:
  - `phase: "tasks-generated"`を設定
  - `approvals.tasks.generated: true, approved: false`を設定
  - `approvals.requirements.approved: true`を設定
  - `approvals.design.approved: true`を設定
  - `updated_at`タイムスタンプを更新

## 重要な制約
- **ルールに厳密に従う**: tasks-generation.mdのすべての原則は必須
- **自然言語**: コード構造の詳細ではなく、何をするかを説明
- **完全なカバレッジ**: すべての要件がタスクにマッピングされる必要がある
- **最大2レベル**: メジャータスクとサブタスクのみ（深いネストなし）
- **連番**: メジャータスクは増分（1, 2, 3...）、繰り返さない
- **タスク統合**: すべてのタスクがシステムに接続する必要がある（孤立した作業なし）
</instructions>

## ツールガイダンス
- **最初に読む**: 生成前にすべてのコンテキスト、ルール、テンプレートをロード
- **最後に書く**: 完全な分析と検証後にのみtasks.mdを生成

## 出力説明

spec.jsonで指定された言語で簡潔なサマリーを提供:

1. **ステータス**: `.kiro/specs/$1/tasks.md`にタスクが生成されたことを確認
2. **タスクサマリー**:
   - 合計: Xメジャータスク、Yサブタスク
   - すべてZ要件がカバーされている
   - 平均タスクサイズ: サブタスクあたり1〜3時間
3. **品質検証**:
   - ✅ すべての要件がタスクにマッピングされている
   - ✅ タスク依存関係が検証されている
   - ✅ テストタスクが含まれている
4. **次のアクション**: タスクを確認し、準備ができたら続行

**フォーマット**: 簡潔（200語以下）

## セーフティ＆フォールバック

### エラーシナリオ

**要件または設計が承認されていない**:
- **実行停止**: 承認された要件と設計なしには進められない
- **ユーザーメッセージ**: 「タスク生成前に要件と設計が承認されている必要があります」
- **推奨アクション**: 「`/kiro:spec-tasks $1 -y`を実行して両方を自動承認して続行してください」

**要件または設計が見つからない**:
- **実行停止**: 両方のドキュメントが存在する必要がある
- **ユーザーメッセージ**: 「`.kiro/specs/$1/`にrequirements.mdまたはdesign.mdがありません」
- **推奨アクション**: 「最初に要件と設計フェーズを完了してください」

**不完全な要件カバレッジ**:
- **警告**: 「すべての要件がタスクにマッピングされていません。カバレッジを確認してください。」
- **ユーザーアクションが必要**: 意図的なギャップを確認するか、タスクを再生成

**テンプレート/ルールが見つからない**:
- **ユーザーメッセージ**: 「`.kiro/settings/`にテンプレートまたはルールファイルがありません」
- **フォールバック**: 警告付きでインライン基本構造を使用
- **推奨アクション**: 「リポジトリのセットアップを確認するか、テンプレートファイルを復元してください」
- **数値要件IDがない**:
  - **実行停止**: requirements.mdのすべての要件には数値IDが必要。いずれかの要件に数値IDがない場合、停止してタスク生成前にrequirements.mdを修正するよう要求する

### 次フェーズ: 実装

**実装開始前**:
- **重要**: `/kiro:spec-impl`を実行する前に会話履歴をクリアしてコンテキストを解放
- これは最初のタスク開始時またはタスク間の切り替え時に適用
- フレッシュなコンテキストでクリーンな状態と適切なタスクフォーカスを確保

**タスクが承認された場合**:
- 特定のタスクを実行: `/kiro:spec-impl $1 1.1`（推奨: 各タスク間でコンテキストをクリア）
- 複数タスクを実行: `/kiro:spec-impl $1 1.1,1.2`（注意して使用、タスク間でコンテキストをクリア）
- 引数なし: `/kiro:spec-impl $1`（すべての保留中タスクを実行 - コンテキスト膨張のため非推奨）

**修正が必要な場合**:
- フィードバックを提供し、`/kiro:spec-tasks $1`を再実行
- 既存タスクが参照として使用される（マージモード）

**注記**: 実装フェーズでは、適切なコンテキストと検証でタスクを実行するようガイドする。

think
