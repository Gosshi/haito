---
description: 仕様の包括的な要件を生成する
allowed-tools: Bash, Glob, Grep, LS, Read, Write, Edit, MultiEdit, Update, WebSearch, WebFetch
argument-hint: <feature-name>
---

# 要件生成

<background_information>
- **ミッション**: spec初期化からのプロジェクト説明に基づいて、EARS形式でテスト可能な包括的な要件を生成する
- **成功基準**:
  - ステアリングコンテキストに整合した完全な要件ドキュメントを作成
  - すべての受け入れ基準にプロジェクトのEARSパターンと制約に従う
  - 実装詳細なしにコア機能に集中
  - 生成ステータスを追跡するためにメタデータを更新
</background_information>

<instructions>
## コアタスク
requirements.mdのプロジェクト説明に基づいて機能 **$1** の完全な要件を生成する。

## 実行ステップ

1. **コンテキストのロード**:
   - 言語とメタデータのために`.kiro/specs/$1/spec.json`を読む
   - プロジェクト説明のために`.kiro/specs/$1/requirements.md`を読む
   - **すべてのステアリングコンテキストをロード**: 以下を含む`.kiro/steering/`ディレクトリ全体を読む:
     - デフォルトファイル: `structure.md`、`tech.md`、`product.md`
     - すべてのカスタムステアリングファイル（モード設定に関係なく）
     - これにより完全なプロジェクトメモリとコンテキストが提供される

2. **ガイドラインを読む**:
   - EARS構文ルールのために`.kiro/settings/rules/ears-format.md`を読む
   - ドキュメント構造のために`.kiro/settings/templates/specs/requirements.md`を読む

3. **要件を生成**:
   - プロジェクト説明に基づいて初期要件を作成
   - 関連する機能を論理的な要件領域にグループ化
   - すべての受け入れ基準にEARS形式を適用
   - spec.jsonで指定された言語を使用

4. **メタデータを更新**:
   - `phase: "requirements-generated"`を設定
   - `approvals.requirements.generated: true`を設定
   - `updated_at`タイムスタンプを更新

## 重要な制約
- HOWではなくWHATに集中（実装詳細なし）
- 要件はテスト可能で検証可能でなければならない
- EARS文には適切な主語を選択（ソフトウェアにはシステム/サービス名）
- 最初に初期バージョンを生成し、その後ユーザーフィードバックで反復（事前に連続質問しない）
- requirements.mdの要件見出しには先頭に数値IDのみを含める必要がある（例: 「要件1」、「1.」、「2 機能...」）。「要件A」のようなアルファベットIDは使用しない
</instructions>

## ツールガイダンス
- **最初に読む**: 生成前にすべてのコンテキストをロード（spec、steering、rules、templates）
- **最後に書く**: 完全な生成後にのみrequirements.mdを更新
- 外部ドメイン知識が必要な場合のみ**WebSearch/WebFetch**を使用

## 出力説明
spec.jsonで指定された言語で出力を提供:

1. **生成された要件サマリー**: 主要な要件領域の簡潔な概要（3〜5箇条書き）
2. **ドキュメントステータス**: requirements.mdの更新とspec.jsonメタデータの更新を確認
3. **次のステップ**: 続行方法（承認して続行、または修正）をユーザーにガイド

**フォーマット要件**:
- 明確にするためにMarkdown見出しを使用
- コードブロックにファイルパスを含める
- サマリーを簡潔に保つ（300語以下）

## セーフティ＆フォールバック

### エラーシナリオ
- **プロジェクト説明がない**: requirements.mdにプロジェクト説明がない場合、機能の詳細をユーザーに尋ねる
- **要件が曖昧**: 多くの事前質問をするのではなく、初期バージョンを提案してユーザーと反復
- **テンプレートがない**: テンプレートファイルが存在しない場合、警告付きでインラインフォールバック構造を使用
- **言語が未定義**: spec.jsonで言語が指定されていない場合、英語（`en`）にデフォルト
- **不完全な要件**: 生成後、要件がすべての期待される機能をカバーしているかユーザーに明示的に確認
- **ステアリングディレクトリが空**: プロジェクトコンテキストがないことを警告し、要件品質に影響する可能性があることを伝える
- **非数値の要件見出し**: 既存の見出しに先頭の数値IDがない場合（例: 「要件A」を使用）、数値IDに正規化し、そのマッピングを一貫して保持する（数値とアルファベットのラベルを混在させない）

### 次フェーズ: 設計生成

**要件が承認された場合**:
- `.kiro/specs/$1/requirements.md`で生成された要件を確認
- **オプションのギャップ分析**（既存コードベースの場合）:
  - 現在のコードとの実装ギャップを分析するために`/kiro:validate-gap $1`を実行
  - 既存コンポーネント、統合ポイント、実装戦略を特定
  - ブラウンフィールドプロジェクトに推奨; グリーンフィールドではスキップ
- その後`/kiro:spec-design $1 -y`で設計フェーズに進む

**修正が必要な場合**:
- フィードバックを提供し、`/kiro:spec-requirements $1`を再実行

**注記**: 設計フェーズに進む前に承認は必須。

think
