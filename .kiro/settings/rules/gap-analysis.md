# ギャップ分析プロセス

## 目的
要件と既存コードベース間のギャップを分析し、実装戦略の決定に情報を提供する。

## 分析フレームワーク

### 1. 現状調査

- ドメイン関連資産をスキャン:
  - 主要なファイル/モジュールとディレクトリ構成
  - 再利用可能なコンポーネント/サービス/ユーティリティ
  - 主要なアーキテクチャパターンと制約

- 規約を抽出:
  - 命名、レイヤリング、依存関係の方向
  - インポート/エクスポートパターンと依存関係のホットスポット
  - テストの配置とアプローチ

- 統合サーフェスを記録:
  - データモデル/スキーマ、APIクライアント、認証メカニズム

### 2. 要件実現可能性分析

- EARS要件から技術ニーズをリスト化:
  - データモデル、API/サービス、UI/コンポーネント
  - ビジネスルール/検証
  - 非機能要件: セキュリティ、パフォーマンス、スケーラビリティ、信頼性

- ギャップと制約を特定:
  - 現在のコードベースにない機能
  - 後で調査が必要な不明点（「要調査」としてマーク）
  - 既存のアーキテクチャとパターンからの制約

- 複雑さの兆候を記録:
  - シンプルなCRUD / アルゴリズムロジック / ワークフロー / 外部統合

### 3. 実装アプローチオプション

#### オプションA: 既存コンポーネントの拡張
**検討すべき場合**: 機能が既存の構造に自然に適合する

- **拡張するファイル/モジュール**:
  - 変更が必要な特定のファイルを特定
  - 既存機能への影響を評価
  - 後方互換性の懸念を評価

- **互換性評価**:
  - 拡張が既存インターフェースを尊重するかチェック
  - 消費者に対する破壊的変更がないことを確認
  - テストカバレッジへの影響を評価

- **複雑さと保守性**:
  - 追加機能の認知負荷を評価
  - 単一責任原則が維持されているかチェック
  - ファイルサイズが管理可能かどうかを評価

**トレードオフ**:
- ✅ 新しいファイルが最小限、初期開発が速い
- ✅ 既存のパターンとインフラストラクチャを活用
- ❌ 既存コンポーネントが肥大化するリスク
- ❌ 既存ロジックが複雑になる可能性

#### オプションB: 新規コンポーネントの作成
**検討すべき場合**: 機能に明確な責任があるか、既存コンポーネントが既に複雑

- **新規作成の根拠**:
  - 関心の明確な分離が新しいファイルを正当化
  - 既存コンポーネントが既に複雑
  - 機能に独自のライフサイクルまたは依存関係がある

- **統合ポイント**:
  - 新しいコンポーネントが既存システムにどのように接続するか
  - 公開されるAPIまたはインターフェース
  - 既存コンポーネントへの依存関係

- **責任境界**:
  - 新しいコンポーネントが所有するものの明確な定義
  - 既存コンポーネントとのインターフェース
  - データフローと制御フロー

**トレードオフ**:
- ✅ 関心の明確な分離
- ✅ 分離でのテストが容易
- ✅ 既存コンポーネントの複雑さを軽減
- ❌ ナビゲートするファイルが増える
- ❌ 慎重なインターフェース設計が必要

#### オプションC: ハイブリッドアプローチ
**検討すべき場合**: 拡張と新規作成の両方が必要な複雑な機能

- **組み合わせ戦略**:
  - どの部分が既存コンポーネントを拡張するか
  - どの部分が新しいコンポーネントを正当化するか
  - それらがどのように相互作用するか

- **段階的実装**:
  - 初期フェーズ: 最小限の実行可能な変更
  - 後続フェーズ: リファクタリングまたは新しいコンポーネント
  - 必要に応じてマイグレーション戦略

- **リスク軽減**:
  - 段階的なロールアウトアプローチ
  - フィーチャーフラグまたは設定
  - ロールバック戦略

**トレードオフ**:
- ✅ 複雑な機能に対するバランスの取れたアプローチ
- ✅ 反復的な改善が可能
- ❌ より複雑な計画が必要
- ❌ 適切に調整されないと一貫性がなくなる可能性

### 4. ギャップ分析のスコープ外

- 深い調査活動は設計フェーズに委ねる
- 不明点は簡潔な「要調査」項目としてのみ記録する

### 5. 実装の複雑さとリスク

  - 工数:
    - S（1〜3日）: 既存パターン、最小限の依存関係、単純な統合
    - M（3〜7日）: 一部の新しいパターン/統合、中程度の複雑さ
    - L（1〜2週間）: 重要な機能、複数の統合またはワークフロー
    - XL（2週間以上）: アーキテクチャ変更、不慣れな技術、広範な影響
  - リスク:
    - 高: 未知の技術、複雑な統合、アーキテクチャシフト、パフォーマンス/セキュリティパスが不明確
    - 中: ガイダンスのある新しいパターン、管理可能な統合、既知のパフォーマンスソリューション
    - 低: 確立されたパターンを拡張、馴染みのある技術、明確なスコープ、最小限の統合

### 出力チェックリスト

- ギャップがタグ付けされた要件から資産へのマップ（欠落 / 不明 / 制約）
- 短い根拠とトレードオフを含むオプションA/B/C
- 工数（S/M/L/XL）とリスク（高/中/低）および1行の正当化
- 設計フェーズへの推奨:
  - 推奨アプローチと主要な決定
  - 引き継ぐ調査項目

## 原則

- **決定よりも情報**: 最終決定ではなく分析とオプションを提供
- **複数の実行可能なオプション**: 該当する場合は信頼できる代替案を提供
- **明示的なギャップと仮定**: 不明点と制約を明確にフラグする
- **コンテキスト認識**: 既存のパターンとアーキテクチャの制限に合わせる
- **透明な工数とリスク**: ラベルを簡潔に正当化する
