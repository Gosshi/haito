# データベース標準

[目的: スキーマ設計、クエリ、マイグレーション、整合性のガイド]

## 哲学
- まずドメインをモデル化; 正確さの後に最適化
- 明示的な制約を優先; データベースに不変条件を強制させる
- 必要なものだけをクエリ; 最適化前に測定

## 命名と型
- テーブル: `snake_case`、複数形（`users`, `order_items`）
- カラム: `snake_case`（`created_at`, `user_id`）
- FK: `{table}_id`が`{table}.id`を参照
- 型: タイムゾーン対応タイムスタンプ; 強いID; 正確な金額型

## 関係
- 1:N: 子にFK
- N:N: 複合キーを持つ結合テーブル
- 1:1: FK + UNIQUE

## マイグレーション
- イミュータブルなマイグレーション; 常にロールバックを追加
- 小さく焦点を絞ったステップ; 非本番環境で先にテスト
- 命名: `{seq}_{action}_{object}`（例: `002_add_email_index`）

## クエリパターン
- 単純なCRUDと安全性にはORM; 複雑/パフォーマンス重要には生SQL
- N+1を避ける（イーガーロード/バッチ処理）; 大きなセットはページネーション
- FKと頻繁にフィルタ/ソートされるカラムにインデックス

## 接続とトランザクション
- プーリングを使用（ワークロードに基づいたサイズ/タイムアウト）
- 作業単位ごとに1接続; 迅速にクローズ/返却
- 複数ステップの変更をトランザクションでラップ

## データ整合性
- NOT NULL/UNIQUE/CHECK/FK制約を使用
- 必要に応じてDBで検証（多層防御）
- 一貫した導出には生成カラムを優先

## バックアップとリカバリー
- 保持期間付きの定期バックアップ; リストアをテスト
- RPO/RTO目標を文書化; バックアップジョブを監視

---
_パターンと決定に焦点を当てる。環境固有の設定なし。_
