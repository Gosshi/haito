# Haito Phase 2 - /kiro:spec-init 説明文
## プロジェクト概要

**プロジェクト名:** Haito（配当）- Phase 2

**現在の状態:**
Phase 1（Week 1-2）が完了し、以下の機能が実装済み：
- ユーザー認証（Supabase Auth）
- 銘柄登録・編集・削除
- 配当データ自動取得
- 年間配当額表示（口座種別ごとの税引前/税引後）
- 月別配当カレンダー

**Phase 2の目的:**
ユーザビリティ向上と継続利用を促す機能の追加。CSVインポートで初期登録の手間を削減し、目標設定機能でモチベーション維持を支援する。

---

## 技術スタック（既存）

- **フロントエンド:** Next.js 14 (App Router) + TypeScript
- **UI:** Tailwind CSS + shadcn/ui
- **状態管理:** Zustand
- **認証:** Supabase Auth
- **データベース:** Supabase (PostgreSQL)
- **ホスティング:** Vercel

---

## Phase 2 機能要件（Week 3-4）

### F6: CSV一括インポート

**概要:**
証券会社からダウンロードしたCSVファイルをアップロードし、複数銘柄を一括登録する。

**対応フォーマット:**
1. **SBI証券** - 保有証券一覧CSV
2. **楽天証券** - 保有商品一覧CSV
3. **汎用フォーマット** - ユーザーが手動で作成したCSV

**汎用CSVフォーマット仕様:**
```csv
銘柄コード,銘柄名,保有株数,取得単価,口座種別
8306,三菱UFJ,100,1250,nisa_growth
9433,KDDI,50,4500,specific
```

**機能詳細:**
- CSVファイルのドラッグ&ドロップまたはファイル選択でアップロード
- アップロード後、プレビュー画面で内容確認
- 証券会社フォーマット自動検出（ヘッダー行から判定）
- 既存銘柄との重複チェック
  - 同一銘柄・同一口座種別が存在 → 上書き or スキップを選択可能
- バリデーションエラーの行をハイライト表示
- 一括登録実行後、成功/失敗件数を表示

**UI:**
- `/portfolio` ページに「CSVインポート」ボタン追加
- モーダルまたは専用ページ `/portfolio/import` でインポート処理

---

### F7: 配当利回りランキング

**概要:**
保有銘柄を配当利回り順にソートして表示し、ポートフォリオの分析を支援する。

**機能詳細:**
- `/portfolio` ページにソート機能を追加
- ソート項目:
  - 配当利回り（高い順/低い順）
  - 年間配当額（高い順/低い順）
  - 銘柄コード順
  - 取得日順（追加予定であれば）
- デフォルトは配当利回り（高い順）
- 現在のソート状態をUIで明示

**追加表示項目:**
- 各銘柄の配当利回り（取得価格ベース）をカラム追加
- ポートフォリオ全体の平均配当利回りをサマリーに表示

---

### F8: 目標設定と進捗表示

**概要:**
年間配当目標を設定し、現在の達成率を可視化してモチベーション維持を支援する。

**機能詳細:**

**目標設定:**
- `/settings` ページに目標設定セクション追加
- 設定項目:
  - 年間配当目標額（円）
  - 目標達成期限（任意、例: 2032年）
- 設定は `user_settings` テーブルに保存

**進捗表示:**
- `/dashboard` ページに目標進捗ウィジェット追加
- 表示内容:
  - 目標額: ¥1,500,000
  - 現在の年間配当額: ¥180,000
  - 達成率: 12%
  - プログレスバーで視覚化
- 目標未設定時は「目標を設定しましょう」のCTAを表示

**追加機能（任意）:**
- 目標達成に必要な追加投資額の試算
  - 例: 「目標達成まであと¥1,320,000の配当が必要です。利回り4%で投資する場合、約¥33,000,000の追加投資が必要です。」

---

## データベース変更

### user_settings テーブル（既存を拡張）

```sql
-- 既存のuser_settingsに以下カラムが存在することを確認（なければ追加）
ALTER TABLE user_settings 
ADD COLUMN IF NOT EXISTS annual_dividend_goal DECIMAL(12,2),
ADD COLUMN IF NOT EXISTS goal_deadline_year INTEGER;
```

---

## 画面変更

```
/portfolio          → 「CSVインポート」ボタン追加、ソート機能追加
/portfolio/import   → CSVインポート専用ページ（またはモーダル）
/dashboard          → 目標進捗ウィジェット追加
/settings           → 目標設定セクション追加
```

---

## 開発ルール

### 重要：役割分担
- **設計（spec, doc）:** Claude Code で実行
- **実装（code）:** Codex で実行

### 優先順位
1. F6: CSV一括インポート（ユーザー獲得時の初期設定負荷を下げる）
2. F8: 目標設定と進捗表示（継続利用のモチベーション）
3. F7: 配当利回りランキング（分析機能の強化）

### 注意事項
- 既存のPhase 1コードを壊さないこと
- 新機能は既存のUIパターン（shadcn/ui）に合わせる
- CSVパーサーはエッジケース（空行、文字化け、不正フォーマット）に対応

---

## テスト観点

### F6: CSVインポート
- 正常系: SBI/楽天/汎用フォーマットの正常インポート
- 異常系: 不正なCSV、文字化け、必須項目欠落
- 境界値: 0件、1件、100件以上のインポート
- 重複: 既存銘柄との重複時の挙動

### F7: ソート機能
- 各ソート項目での正しいソート
- ソート切り替え時のUI更新

### F8: 目標設定
- 目標の保存/更新/削除
- 進捗率の正しい計算
- 目標未設定時の表示

---

## 非機能要件

- **CSVインポート:** 100件のインポートが5秒以内に完了
- **UX:** インポート中はローディング表示、進捗がわかるようにする

---

## 将来の拡張（Phase 3以降で検討）

- 複数の目標設定（短期/中期/長期）
- 目標達成シミュレーター（増配率考慮）
- 証券会社API連携（自動同期）
- CSVエクスポート機能

---

*この説明を元にcc-sddワークフローでspec → doc → code と進めてください。*
*実装（code）フェーズではCodexに切り替えることを忘れずに。*